name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]
  pull_request:
    types: [opened, synchronize, labeled]  # Neu: Für automatische Reviews

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude'))) ||
      (github.event_name == 'pull_request')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Geändert: Für Diff-Vergleiche

      - name: Run Claude Code (Full Review)
        if: |
          github.event_name == 'pull_request' && 
          contains(github.event.pull_request.labels.*.name, 'full-review')
        id: claude-full
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Lies zuerst die Coding Guidelines aus .github/claude-guidelines.md
            
            Führe eine KOMPLETTE TypeScript React Review durch:
            - Alle .ts und .tsx Dateien in diesem PR
            - Type Coverage und Type Consistency
            - React Best Practices im gesamten Code
            - Performance-Probleme
            - Accessibility Issues
            
            Prüfe besonders:
            1. Type Safety - alle Props, State, Events korrekt typisiert
            2. Keine any Types oder Type Assertions ohne Grund
            3. React Hooks Dependencies
            4. Event Handlers mit korrekten React Event Types
            5. Einhaltung der Naming Conventions
            
            Kommentiere direkt in den Code-Zeilen bei Problemen.

      - name: Run Claude Code (Changes Only - Default)
        if: |
          github.event_name == 'pull_request' && 
          !contains(github.event.pull_request.labels.*.name, 'full-review') &&
          !contains(github.event.pull_request.labels.*.name, 'skip-review')
        id: claude-changes
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Lies zuerst die Coding Guidelines aus .github/claude-guidelines.md
            
            Reviewe NUR die GEÄNDERTEN Zeilen (Diff) in diesem Pull Request.
            Ignoriere unveränderten Code komplett.
            
            Prüfe die Änderungen auf:
            1. Type Safety - neue/geänderte Types korrekt
            2. Keine neuen any Types
            3. React Hooks korrekt typisiert
            4. Event Handlers mit React Event Types
            5. Breaking Changes
            6. Performance Implications der Änderungen
            7. Einhaltung unserer Guidelines
            
            Kommentiere nur bei tatsächlichen Problemen in den geänderten Zeilen.

      - name: Run Claude Code (Manual @claude mentions)
        if: |
          (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
          (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
          (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
          (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
        id: claude-manual
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}